<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ pref.name }} - Travel Memories</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: {{ bg_color }}; color: #2c3e50; margin: 0; padding: 0; transition: background-color 0.5s; }
        .nav-bar { padding: 20px 40px; }
        .back-link { color: #555; text-decoration: none; font-weight: 700; font-size: 16px; background: rgba(255,255,255,0.6); padding: 8px 15px; border-radius: 20px; transition: background 0.3s; }
        .back-link:hover { background: #fff; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px 40px; }
        .control-panel { background: rgba(255,255,255,0.9); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 40px; display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-end; justify-content: space-between; }
        
        .title-group h1 { margin: 0 0 10px 0; font-size: 36px; color: {{ main_color }}; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .home-badge { font-size: 16px; color: #e74c3c; border: 2px solid #e74c3c; padding: 4px 12px; border-radius: 20px; margin-left: 15px; background: #fff; font-weight: 700; letter-spacing: 1px; }
        .home-message { color: #7f8c8d; font-size: 15px; font-weight: bold; width: 100%; margin-top: 10px; }
        
        .date-container { display: flex; align-items: center; gap: 10px; width: 280px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .input-group label { font-size: 14px; font-weight: 700; color: #7f8c8d; }
        
        input[type="text"].date-range-picker { padding: 12px 15px; border-radius: 8px; border: 1px solid #dfe6e9; font-family: inherit; font-size: 15px; color: #2c3e50; outline: none; background-color: #fff; cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s; width: 100%; box-sizing: border-box; }
        input[type="text"].date-range-picker:hover { border-color: {{ main_color }}; }
        input[type="text"].date-range-picker:focus { border-color: {{ main_color }}; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn { border: none; background-color: {{ main_color }}; color: white; padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: background 0.3s; }
        .upload-btn-wrapper:hover .upload-btn { filter: brightness(0.9); }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .photo-item { position: relative; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: transform 0.3s; background: #fff; height: 280px; cursor: pointer; }
        .photo-item:hover { transform: translateY(-5px); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(231, 76, 60, 0.9); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .photo-item:hover .delete-btn { opacity: 1; }
        .empty-state { text-align: center; padding: 60px 20px; color: #95a5a6; font-size: 18px; grid-column: 1 / -1; background: rgba(255,255,255,0.7); border-radius: 20px; border: 2px dashed #bdc3c7; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { display: block; max-width: 90%; max-height: 85vh; margin: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: contain; }
        .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .close:hover { color: #bbb; }
        .prev, .next { cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%); width: auto; padding: 20px; color: white; font-weight: bold; font-size: 40px; transition: 0.3s; user-select: none; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .prev:hover, .next:hover { background-color: rgba(0,0,0,0.8); }
        .prev { left: 5%; }
        .next { right: 5%; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="{% url 'map' %}" class="back-link">‚Üê Back to Map</a>
    </div>

    <div class="container">
        <div class="control-panel">
            <div class="title-group">
                <h1>
                    {{ pref.name }}
                    {% if pref.is_home %}
                        <span class="home-badge">HOME</span>
                    {% endif %}
                </h1>
            </div>

            {% if not pref.is_home %}
                <div class="date-container">
                    <div class="input-group">
                        <label>Travel Period</label>
                        <input type="text" id="visitDateRange" class="date-range-picker" placeholder="üìÖ Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" readonly>
                    </div>
                </div>

                <div class="input-group">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="upload-btn-wrapper">
                            <button type="button" class="upload-btn">+ Upload Photos</button>
                            <input type="file" name="images" multiple accept="image/*" onchange="this.form.submit()">
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="home-message">
                    üìç „Åì„Åì„ÅØHOME„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊóÖË°åÊúüÈñì„ÇÑÂÜôÁúü„ÅÆËøΩÂä†„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
                </div>
            {% endif %}
        </div>

        {% if not pref.is_home %}
        <div class="photo-grid">
            {% for photo in photos %}
                <div class="photo-item" onclick="openModal({{ forloop.counter0 }})">
                    {% if photo.thumbnail %}
                        <img src="{{ photo.thumbnail.url }}" alt="Photo">
                    {% else %}
                        <img src="{{ photo.image.url }}" alt="Photo">
                    {% endif %}
                    
                    <form method="post" onsubmit="event.stopPropagation();" style="position: absolute; top:0; right:0; width: 100%; height: 100%;">
                        {% csrf_token %}
                        <input type="hidden" name="delete_photo_id" value="{{ photo.id }}">
                        <button type="submit" class="delete-btn" title="Delete" onclick="event.stopPropagation();">√ó</button>
                    </form>
                </div>
            {% empty %}
                <div class="empty-state">No photos uploaded yet. Select some pictures to remember your trip!</div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div id="photoModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <span class="prev" onclick="changeSlide(-1)">&#10094;</span>
        <img class="modal-content" id="modal-img">
        <span class="next" onclick="changeSlide(1)">&#10095;</span>
    </div>

    <script>
        const savedDateStr = "{{ pref.visit_date|escapejs }}";
        const dateInput = document.getElementById('visitDateRange');

        if (dateInput) {
            flatpickr("#visitDateRange", {
                mode: "range",          
                locale: "ja",           
                dateFormat: "Y/m/d",    
                defaultDate: savedDateStr ? savedDateStr.split(' - ') : null, 
                
                onChange: function(selectedDates, dateStr, instance) {
                    let finalStr = "";
                    if (selectedDates.length === 2) {
                        const d1 = instance.formatDate(selectedDates[0], "Y/m/d");
                        const d2 = instance.formatDate(selectedDates[1], "Y/m/d");
                        finalStr = d1 + " - " + d2;
                    } else if (selectedDates.length === 1) {
                        finalStr = instance.formatDate(selectedDates[0], "Y/m/d");
                    }
                    
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch('', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                        body: JSON.stringify({ 'visit_date': finalStr })
                    });
                }
            });
        }

        const photoUrls = [
            {% for photo in photos %}
                "{{ photo.image.url }}",
            {% endfor %}
        ];
        
        let currentSlideIndex = 0;

        function openModal(index) {
            currentSlideIndex = index;
            document.getElementById("photoModal").style.display = "block";
            document.getElementById("modal-img").src = photoUrls[currentSlideIndex];
        }

        function closeModal() {
            document.getElementById("photoModal").style.display = "none";
        }

        function changeSlide(direction) {
            currentSlideIndex += direction;
            if (currentSlideIndex >= photoUrls.length) { currentSlideIndex = 0; }
            if (currentSlideIndex < 0) { currentSlideIndex = photoUrls.length - 1; }
            document.getElementById("modal-img").src = photoUrls[currentSlideIndex];
        }
    </script>
</body>
</html>