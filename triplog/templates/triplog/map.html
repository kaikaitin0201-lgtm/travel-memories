<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Travel Memories</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #2c3e50; }
        .header { background: #fff; padding: 15px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 28px; font-weight: 900; letter-spacing: 1px; color: #2c3e50; }
        .stats-container { display: flex; flex-direction: column; gap: 8px; background: #ffffff; padding: 12px 24px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 1px solid #f1f2f6; min-width: 220px; }
        .stats-text { display: flex; justify-content: space-between; align-items: flex-end; }
        .stats-label { font-size: 14px; font-weight: 700; color: #95a5a6; letter-spacing: 1.5px; }
        .stats-numbers { display: flex; align-items: baseline; gap: 4px; }
        .count-highlight { font-size: 34px; font-weight: 900; color: #3498db; line-height: 1; }
        .count-total { font-size: 16px; font-weight: 700; color: #bdc3c7; }
        .progress-bar-bg { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px; width: 0%; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .main-container { display: flex; max-width: 1400px; margin: 0 auto; padding: 30px; gap: 30px; height: 80vh; }
        .map-area { flex: 7; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; position: relative; }
        #map-container { width: 100%; height: 100%; }
        .sidebar-area { flex: 3; display: flex; flex-direction: column; gap: 20px; height: 100%; }
        
        .list-panel { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); flex-grow: 1; overflow-y: auto; }
        .list-header { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 15px; }
        .list-header h3 { margin: 0; font-size: 18px; color: #34495e; }
        
        .btn-set-home { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 13px; font-weight: bold; transition: color 0.3s; padding: 0; }
        .btn-set-home:hover { color: #e74c3c; }

        .visited-grid { display: flex; flex-direction: column; gap: 10px; }
        .visited-card { display: block; padding: 12px; background: #fdfdfd; border-radius: 8px; text-decoration: none; color: #2c3e50; border-left: 6px solid #ccc; transition: transform 0.2s, box-shadow 0.2s; }
        .visited-card:hover { transform: translateX(5px); background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .visited-card .pref-name { font-weight: 700; font-size: 16px; margin-bottom: 3px; }
        .visited-card .pref-date { font-size: 12px; color: #7f8c8d; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fff; margin: 15% auto; padding: 25px; border-radius: 15px; width: 80%; max-width: 320px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .close-modal { position: absolute; right: 15px; top: 10px; color: #bdc3c7; font-size: 28px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .close-modal:hover { color: #2c3e50; }
        .modal-content h3 { margin-top: 0; color: #c0392b; font-size: 20px; margin-bottom: 10px; }
        .modal-content select { width: 100%; padding: 10px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #dfe6e9; font-size: 15px; outline: none; }
        .modal-content select:focus { border-color: #e74c3c; }
        .modal-content button { background: #e74c3c; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: background 0.3s; }
        .modal-content button:hover { background: #c0392b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Travel Memories</h1>
        <div class="stats-container">
            <div class="stats-text">
                <span class="stats-label">VISITED</span>
                <div class="stats-numbers">
                    <span id="visit-count" class="count-highlight">0</span>
                    <span class="count-total">/ 47</span>
                </div>
            </div>
            <div class="progress-bar-bg">
                <div id="progress-bar-fill" class="progress-bar-fill"></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="map-area">
            <div id="map-container"></div>
        </div>

        <div class="sidebar-area">
            <div class="list-panel">
                <div class="list-header">
                    <h3>Visited Places</h3>
                    <button class="btn-set-home" onclick="openHomeModal()">üè† Set HOME</button>
                </div>
                <div id="visited-grid" class="visited-grid"></div>
            </div>
        </div>
    </div>

    <div id="homeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHomeModal()">&times;</span>
            <h3>üè† Set HOME</h3>
            <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 15px;">Ëá™ÂàÜ„ÅÆ‰Ωè„Çì„Åß„ÅÑ„ÇãÈÉΩÈÅìÂ∫úÁúå„ÇíË®≠ÂÆö„ÉªËß£Èô§„Åß„Åç„Åæ„Åô</p>
            <select id="home-select"></select>
            <button onclick="toggleHome()">Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åô„Çã</button>
        </div>
    </div>

    <script>
        const prefData = {{ pref_json|safe }};
        const prefDataMap = {};
        prefData.forEach(d => { prefDataMap[d.name] = d; });

        const allPrefectures = [
            "ÂåóÊµ∑ÈÅì", "ÈùíÊ£ÆÁúå", "Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå", "Á¶èÂ≥∂Áúå", "Ëå®ÂüéÁúå", "Ê†ÉÊú®Áúå", "Áæ§È¶¨Áúå", "ÂüºÁéâÁúå", "ÂçÉËëâÁúå", "Êù±‰∫¨ÈÉΩ", "Á•ûÂ•àÂ∑ùÁúå", "Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Á¶è‰∫ïÁúå", "Â±±Ê¢®Áúå", "Èï∑ÈáéÁúå", "Â≤êÈòúÁúå", "ÈùôÂ≤°Áúå", "ÊÑõÁü•Áúå", "‰∏âÈáçÁúå", "ÊªãË≥ÄÁúå", "‰∫¨ÈÉΩÂ∫ú", "Â§ßÈò™Â∫ú", "ÂÖµÂ∫´Áúå", "Â•àËâØÁúå", "ÂíåÊ≠åÂ±±Áúå", "È≥•ÂèñÁúå", "Â≥∂Ê†πÁúå", "Â≤°Â±±Áúå", "Â∫ÉÂ≥∂Áúå", "Â±±Âè£Áúå", "Âæ≥Â≥∂Áúå", "È¶ôÂ∑ùÁúå", "ÊÑõÂ™õÁúå", "È´òÁü•Áúå", "Á¶èÂ≤°Áúå", "‰ΩêË≥ÄÁúå", "Èï∑Â¥éÁúå", "ÁÜäÊú¨Áúå", "Â§ßÂàÜÁúå", "ÂÆÆÂ¥éÁúå", "ÈπøÂÖêÂ≥∂Áúå", "Ê≤ñÁ∏ÑÁúå"
        ];

        const homeModal = document.getElementById("homeModal");
        function openHomeModal() { homeModal.style.display = "block"; }
        function closeHomeModal() { homeModal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == homeModal) { closeHomeModal(); } }

        const selectBox = document.getElementById('home-select');
        allPrefectures.forEach(pref => {
            const opt = document.createElement('option');
            opt.value = pref;
            opt.textContent = prefDataMap[pref] && prefDataMap[pref].is_home ? `‚òÖ ${pref} (Ë®≠ÂÆöÊ∏à)` : pref;
            selectBox.appendChild(opt);
        });

        function toggleHome() {
            const selected = selectBox.value;
            const csrfToken = '{{ csrf_token }}';
            fetch('', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ 'toggle_home': selected })
            }).then(() => location.reload()); 
        }

        const numColors = 48;
        const customColorScale = [[0, '#ffffff'], [1/numColors, '#ffffff']];
        const prefColors = {};
        
        for(let i = 0; i < 47; i++) {
            const h = (i / 47.0) * 360; 
            const color = `hsl(${h}, 85%, 55%)`;
            prefColors[allPrefectures[i]] = color;

            const start = (i + 1) / numColors;
            const end = (i + 2) / numColors;
            if (start <= 1) customColorScale.push([start, color]);
            if (end <= 1) customColorScale.push([end, color]);
        }

        fetch('https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson')
            .then(response => response.json())
            .then(geojson => {
                let visitCount = 0;
                const visitedList = [];

                const zValues = allPrefectures.map((pref, index) => {
                    const data = prefDataMap[pref];
                    if (data && (data.has_photos || data.is_home)) {
                        visitCount++;
                        if (!data.is_home) {
                            visitedList.push({ name: pref, date: data.visit_date });
                        }
                        return index + 1;
                    }
                    return 0;
                });

                document.getElementById('visit-count').innerText = visitCount;
                setTimeout(() => {
                    const percent = (visitCount / 47) * 100;
                    document.getElementById('progress-bar-fill').style.width = percent + '%';
                }, 100);

                const hoverTexts = allPrefectures.map(pref => {
                    const data = prefDataMap[pref];
                    if (!data) return pref;
                    const label = data.is_home ? '[HOME] ' : '';
                    return `<b>${label}${pref}</b><br>Date: ${data.visit_date || '----'}`;
                });

                const data = [{
                    type: 'choropleth',
                    geojson: geojson,
                    locations: allPrefectures,
                    z: zValues,
                    text: hoverTexts,
                    hoverinfo: 'text',
                    featureidkey: 'properties.nam_ja',
                    colorscale: customColorScale,
                    zmin: 0, zmax: 47,
                    showscale: false,
                    marker: { line: { color: '#000000', width: 0.5 } } 
                }];

                const layout = {
                    geo: { fitbounds: 'locations', visible: false, projection: { type: 'mercator' } },
                    margin: { r: 10, t: 10, l: 10, b: 10 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('map-container', data, layout, {displayModeBar: false});

                document.getElementById('map-container').on('plotly_click', function(data){
                    window.location.href = `/pref/${data.points[0].location}/`;
                });

                const grid = document.getElementById('visited-grid');
                if (visitedList.length === 0) {
                    grid.innerHTML = '<div style="color: #95a5a6; font-size: 14px; text-align: center; padding: 20px;">No places visited yet.</div>';
                } else {
                    visitedList.forEach(item => {
                        const card = document.createElement('a');
                        card.href = `/pref/${item.name}/`;
                        card.className = 'visited-card';
                        card.style.borderLeftColor = prefColors[item.name];
                        
                        card.innerHTML = `
                            <div class="pref-name">${item.name}</div>
                            <div class="pref-date">${item.date || 'Date not set'}</div>
                        `;
                        grid.appendChild(card);
                    });
                }
            });
    </script>
</body>
</html>